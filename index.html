<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catálogo Opella | Fevereiro 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js para Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF para Exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* --- BLOQUEIO DE ROLAGEM ROBUSTO PARA MOBILE --- */
        html.no-scroll, body.no-scroll {
            overflow: hidden !important;
            height: 100% !important;
            overscroll-behavior: none;
            position: relative;
        }

        /* --- SCROLLBAR CUSTOMIZADA E VISÍVEL PARA DESKTOP --- */
        .custom-scrollbar {
            cursor: grab;
            scrollbar-width: thin; 
            scrollbar-color: #94a3b8 #f1f1f1; 
            padding-bottom: 4px; 
        }
        .custom-scrollbar:active { cursor: grabbing; }
        
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px; 
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8; 
            border-radius: 4px;
            border: 2px solid #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* --- ESTILOS DE MARCAS E BOTÕES ATIVOS --- */
        .card-dorflex { border-left: 5px solid #E20613; background: linear-gradient(to right, #fff, #fef2f2); }
        .text-dorflex { color: #003B71; }
        .btn-dorflex-active { background-color: #E20613 !important; color: white !important; }

        .card-entero { border-left: 5px solid #009EE2; background: linear-gradient(to right, #ffffff, #f0f9ff); }
        .text-entero { color: #009EE2; }
        .btn-enterogermina-active { background-color: #009EE2 !important; color: white !important; }
        
        .card-allegra { border-left: 5px solid #C5007F; background: linear-gradient(to right, #fff, #fdf4ff); }
        .text-allegra { color: #6a0d91; }
        .btn-allegra-active { background-color: #C5007F !important; color: white !important; }

        .card-novalgina { border-left: 5px solid #009640; background: linear-gradient(to right, #fff, #f0fdf4); }
        .text-novalgina { color: #009640; }
        .btn-novalgina-active { background-color: #009640 !important; color: white !important; }

        .card-anador { border-left: 5px solid #FFBD59; background: linear-gradient(to right, #fff, #fffaf0); }
        .text-anador { color: #cc7a00; }
        .btn-anador-active { background-color: #FFBD59 !important; color: white !important; }

        .card-targifor { border-left: 5px solid #F57F20; background: linear-gradient(135deg, #fff 80%, #fef7f2 100%); }
        .text-targifor { color: #003B71; }
        .btn-targifor-active { background-color: #F57F20 !important; color: white !important; }

        .card-moura { border-left: 5px solid #0055b8; background: linear-gradient(to right, #fff, #eef6ff); }
        .btn-moura-active { background-color: #0055b8 !important; color: white !important; }

        .card-oscal { border-left: 5px solid #003366; background: linear-gradient(135deg, #fff 80%, #fff0f7 100%); }
        .btn-oscal-active { background-color: #003366 !important; color: white !important; }

        .card-dulco { border-left: 5px solid #00aed9; background: linear-gradient(to right, #fff, #f0fbff); }
        .btn-dulco-active { background-color: #00aed9 !important; color: white !important; }

        .card-bisolvon { border-left: 5px solid #FFD700; background: linear-gradient(135deg, #fff 80%, #f0f4ff 100%); }
        .btn-bisolvon-active { background-color: #FFD700 !important; color: #003B71 !important; }

        .card-fenergan { border-left: 5px solid #32CD32; background: linear-gradient(135deg, #fff 80%, #f0fff4 100%); }
        .btn-fenergan-active { background-color: #32CD32 !important; color: white !important; }

        /* Estilo para botão favoritos ativo */
        .btn-favorites-active { background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }
        
        /* Estilo para botão campanha ativo */
        .btn-campaign-active { background: linear-gradient(135deg, #ff512f 0%, #dd2476 100%) !important; color: white !important; border: none !important; box-shadow: 0 4px 15px rgba(221, 36, 118, 0.4); }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .tier-box {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb; cursor: pointer; user-select: none; background: white;
        }
        .tier-active {
            background-color: #dcfce7 !important;
            border-color: #16a34a !important;
            color: #14532d !important;
            box-shadow: 0 4px 6px -1px rgba(0, 166, 80, 0.2);
            font-weight: 700;
        }
        
        /* Novo estilo para Tiers de Campanha (Descontos Altos) */
        .tier-active-campaign {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%) !important;
            border-color: #f97316 !important;
            color: #c2410c !important;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
            font-weight: 800;
        }
        .tier-box-campaign {
            border-color: #fdba74;
            background-color: #fffaf0;
        }

        .product-card { transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-btn { background-color: #e5e7eb; color: #4b5563; transition: all 0.3s; border-left-width: 4px; padding: 8px 16px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; margin-right: 8px; white-space: nowrap; position: relative; }
        .cat-btn-all-active { background-color: #111827 !important; color: white !important; border-color: transparent !important; }
        
        .promo-badge {
            position: absolute;
            top: -10px; 
            right: 0;
            background-color: #ef4444;
            color: white;
            font-size: 0.55rem;
            padding: 1px 4px;
            border-radius: 9999px;
            font-weight: 900;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
            animation: bounce-slow 2s infinite;
            z-index: 10;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* --- MELHORIAS UX --- */
        .next-tier-hint {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            color: #92400e;
            font-size: 9px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: pulse-soft 2s infinite;
        }
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        .campaign-flash {
            animation: bg-pulse 2s infinite;
        }
        @keyframes bg-pulse {
            0%, 100% { background-color: #fef3c7; } /* Amarelo claro */
            50% { background-color: #fee2e2; } /* Vermelho claro */
        }
        
        /* Destaque para item buscado/clicado */
        @keyframes flash-highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
            50% { box-shadow: 0 0 0 6px rgba(250, 204, 21, 0.7); border-color: #facc15; }
        }
        .highlight-product {
            animation: flash-highlight 1.5s ease-in-out 2;
        }

        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            z-index: 5;
        }
        .favorite-btn:active { transform: scale(0.9); }
        .favorite-btn.active { background: #fef2f2; }
        .favorite-btn .fa-heart { color: #d1d5db; transition: color 0.15s; }
        .favorite-btn.active .fa-heart { color: #ef4444; }

        .quick-reorder-bar {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 12px;
            padding: 10px 12px;
            margin: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .quick-reorder-bar:active { transform: scale(0.98); }
        .quick-reorder-bar:hover { box-shadow: 0 4px 12px rgba(16,185,129,0.15); }

        .brand-summary-checkout {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 8px;
        }
        .brand-summary-checkout .brand-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 6px;
            border-bottom: 1px dashed #e2e8f0;
            margin-bottom: 6px;
        }
        .brand-summary-checkout .brand-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        #category-scroll {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .lazy-img {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }
        .lazy-img.loaded {
            opacity: 1;
        }
        
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="pb-44 bg-gray-100 text-left overflow-x-hidden">

    <!-- Header Fixo -->
    <div id="main-header" class="bg-gray-900 p-4 pb-0 shadow-xl sticky top-0 z-50 rounded-b-[1.5rem]">
        <div class="flex justify-between items-center mb-4 px-1 text-white text-left">
            <div class="bg-white p-1.5 rounded-lg shadow-md">
                <img src="https://www.opella.com/dam/jcr:f38ea294-efa2-4b65-95ed-f58b3c5f103f/opella_logo-intro-anim.svg" alt="Opella" class="h-6 w-auto">
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="openHistoryModal()" class="text-gray-400 hover:text-white transition-colors" title="Histórico">
                    <i class="fas fa-history text-lg"></i>
                </button>
                <button onclick="openDashboard()" class="text-gray-400 hover:text-white transition-colors" title="Dashboard">
                    <i class="fas fa-chart-pie text-lg"></i>
                </button>
                <div class="text-right border-l border-gray-700 pl-3">
                    <h2 class="font-bold text-sm text-right leading-tight">Catálogo Digital</h2>
                    <p class="text-[10px] text-green-400 font-bold uppercase tracking-widest text-right">RCA+ | Fev 2026</p>
                </div>
            </div>
        </div>

        <div class="relative px-1 mb-2">
            <i class="fas fa-search absolute left-5 top-3.5 text-gray-400"></i>
            <input type="text" id="search-input" oninput="render()" 
                placeholder="Busque por nome ou EAN..." 
                class="w-full bg-white h-12 rounded-xl pl-11 pr-4 text-gray-800 font-medium placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-green-500/30 shadow-lg transition-all text-left">
        </div>
        
        <!-- SUB-HEADER CAMPANHA -->
        <div class="mt-2 mb-2 bg-yellow-400 text-red-900 font-black text-center text-[10px] py-1 rounded-lg uppercase tracking-widest campaign-flash shadow-lg mx-1 border border-yellow-500 flex items-center justify-center gap-2">
            <i class="fas fa-bolt"></i> CAMPANHA DE FEVEREIRO ATÉ 28/02 <i class="fas fa-bolt"></i>
        </div>
        
        <p class="text-[10px] text-gray-400 font-medium text-center italic opacity-90 px-2 pb-3 flex justify-center items-center gap-2">
            📦 Selecione as quantidades e veja o pedido se formar em tempo real.
        </p>
    </div>
    
    <!-- Filtros de Categoría (STICKY WRAPPER) -->
    <!-- Ajustado top para 165px -->
    <div id="filters-container" class="sticky top-[165px] z-40 bg-gray-100/95 backdrop-blur-md border-b border-gray-200 transition-all">
        
        <!-- Aviso de Scroll Discreto -->
        <div class="absolute top-2 right-2 z-50 pointer-events-none">
             <span class="text-[9px] text-gray-400 font-bold bg-white/80 px-2 py-0.5 rounded-full shadow-sm backdrop-blur-sm animate-pulse flex items-center gap-1 border border-gray-100">
                Arraste <i class="fas fa-arrow-right"></i>
             </span>
        </div>

        <div id="category-scroll" class="overflow-x-auto whitespace-nowrap custom-scrollbar pt-6 pb-3 pl-4 pr-4 flex items-center relative">
            <button id="btn-all" onclick="setCategory('all')" class="cat-btn cat-btn-all-active border-transparent">Todos</button>
            
            <button id="btn-favorites" onclick="setCategory('favorites')" class="cat-btn border-red-200 text-red-500"><i class="fas fa-heart mr-1"></i> Favoritos</button>
            
            <button id="btn-campaign" onclick="setCategory('campaign')" class="cat-btn border-orange-500 text-orange-600 bg-orange-50 font-bold"><i class="fas fa-fire mr-1"></i> Ofertas Campanha (até 28/02)</button>
            
            <button id="btn-Dorflex" onclick="setCategory('Dorflex')" class="cat-btn border-[#E20613]">Dorflex</button>
            
            <button id="btn-Enterogermina" onclick="setCategory('Enterogermina')" class="cat-btn border-[#009EE2]">
                Enterogermina 🔥
                <span class="promo-badge">Até 30% OFF</span>
            </button>
            
            <button id="btn-Allegra" onclick="setCategory('Allegra')" class="cat-btn border-[#C5007F]">Allegra</button>
            
            <button id="btn-Novalgina" onclick="setCategory('Novalgina')" class="cat-btn border-[#009640]">
                Novalgina 🔥
                <span class="promo-badge">Até 28% OFF</span>
            </button>
            
            <button id="btn-Anador" onclick="setCategory('Anador')" class="cat-btn border-[#FFBD59]">Anador</button>
            <button id="btn-Targifor" onclick="setCategory('Targifor')" class="cat-btn border-[#F57F20]">Targifor / Cewin / Pharmaton</button>
            
            <button id="btn-Moura" onclick="setCategory('Moura')" class="cat-btn border-[#0055b8]">
                Moura Brasil 🔥
                <span class="promo-badge">Até 21% OFF</span>
            </button>
            
            <button id="btn-Oscal" onclick="setCategory('Oscal')" class="cat-btn border-[#003366]">Oscal</button>
            <button id="btn-Dulco" onclick="setCategory('Dulco')" class="cat-btn border-[#00aed9]">Dulcolax</button>
            <button id="btn-Bisolvon" onclick="setCategory('Bisolvon')" class="cat-btn border-[#FFD700]">Bisolvon / Mucosolvan</button>
            <button id="btn-Fenergan" onclick="setCategory('Fenergan')" class="cat-btn border-[#32CD32]">Fenergan</button>
        </div>
    </div>

    <!-- Lista de Produtos -->
    <div id="quick-reorder-container"></div>
    <div id="product-list" class="px-4 space-y-4 max-w-lg mx-auto mt-4 text-left pt-2">
        <!-- JS injeta aqui -->
    </div>

    <!-- Assinatura Sutil -->
    <div class="text-center pt-12 pb-48 px-6 text-left">
        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest border-t border-gray-200 pt-6 mx-8">
            Ferramenta criada para facilitar e economizar.
        </p>
    </div>

    <!-- Barra Inferior (Carrinho Dinâmico) -->
    <div id="cart-bar" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] hidden z-50 animate-slide-up">
        <div class="w-full bg-gray-100 h-2">
            <div id="progress-fill" class="h-full bg-orange-400 transition-all duration-500" style="width: 0%"></div>
        </div>
        
        <div class="max-w-lg mx-auto p-4 flex items-center gap-3 text-left">
            <button onclick="askClearCart()" class="w-12 h-12 flex items-center justify-center bg-gray-100 text-red-500 rounded-xl active:scale-90 transition-transform shadow-sm" title="Limpar Pedido">
                <i class="fas fa-trash-alt text-lg"></i>
            </button>

            <div class="flex-1 text-left text-left">
                <p class="text-[11px] font-bold uppercase tracking-tight text-gray-500 mb-0.5" id="installment-label">Total do Pedido</p>
                <p class="text-2xl font-black text-green-600 leading-none" id="cart-installment">R$ 0,00</p>
                <p class="text-[9px] font-bold text-gray-400 mt-1 text-left" id="cart-total-small">Total: R$ 0,00</p>
            </div>
            
            <button onclick="openModal()" id="btn-review" class="bg-[#00A650] hover:bg-green-600 text-white px-5 py-3.5 rounded-xl font-black shadow-lg flex flex-col items-center justify-center transition-all active:scale-95 text-center disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="text-[10px] uppercase font-black tracking-widest leading-tight">Revisar<br>Pedido</span>
            </button>
        </div>
    </div>

    <!-- Modal Confirmação Limpar Carrinho -->
    <div id="clear-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-xs w-full text-center animate-slide-up">
            <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Limpar Carrinho?</h3>
            <p class="text-xs text-gray-500 mb-6">Isso removerá todos os itens do seu pedido atual. Essa ação não pode ser desfeita.</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeClearModal()" class="py-3 rounded-xl font-bold text-gray-600 bg-gray-100">Cancelar</button>
                <button onclick="performClearCart()" class="py-3 rounded-xl font-bold text-white bg-red-500 shadow-lg">Sim, Limpar</button>
            </div>
        </div>
    </div>

    <!-- Modal Checkout (Revisão Completa) -->
    <div id="checkout-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-end sm:items-center justify-center transition-opacity text-left">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-2xl rounded-t-3xl p-6 h-[85vh] sm:h-auto sm:max-h-[90vh] flex flex-col shadow-2xl animate-slide-up text-left">
            
            <div class="flex justify-between items-center mb-4 border-b pb-4 shrink-0 text-left">
                <h2 class="text-xl font-bold text-gray-800">Seu Pedido</h2>
                <button onclick="closeModal()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>

            <div id="cart-items-preview" class="overflow-y-auto flex-1 space-y-3 pr-1 mb-4 scrollbar-hide py-2 text-left">
                <!-- JS injeta os itens aqui -->
            </div>

            <div id="savings-summary" class="bg-green-50 border border-green-200 rounded-xl p-3 mb-4 flex items-center gap-3 shrink-0 text-left">
                <div class="bg-green-100 text-green-600 p-2 rounded-lg"><i class="fas fa-hand-holding-usd text-lg"></i></div>
                <div class="text-left leading-tight text-left">
                    <p class="text-[10px] text-green-700 font-bold uppercase tracking-tight text-left">Você economizou</p>
                    <p class="text-lg font-black text-green-700 text-left" id="total-savings-modal">R$ 0,00</p>
                </div>
            </div>

            <!-- Seletor de Prazo -->
            <div id="payment-options" class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 hidden shrink-0 text-left">
                <p class="text-[11px] font-bold text-blue-700 uppercase mb-3 tracking-wider text-left">Selecione o Prazo:</p>
                <!-- Grid será preenchido dinamicamente via JS -->
                <div class="grid grid-cols-2 gap-2 text-left" id="payment-options-grid">
                    <!-- Opções injetadas aqui -->
                </div>
            </div>
            
            <div id="payment-single" class="bg-gray-50 p-3 rounded-xl border border-gray-200 mb-4 hidden text-center shrink-0 text-left">
                <p class="text-xs text-gray-600 text-left">Prazo padrão: <strong>50 dias direto</strong></p>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 mb-4 shrink-0 text-left">
                <label class="block text-xs font-bold text-gray-600 uppercase mb-1 text-left">CNPJ do Cliente</label>
                <input type="tel" id="cnpj-input" placeholder="Apenas números" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-lg font-medium outline-none text-left">
            </div>
            
            <div class="grid grid-cols-4 gap-2 shrink-0 pb-2">
                 <button onclick="exportPDF()" class="col-span-1 bg-red-100 text-red-600 hover:bg-red-200 font-bold py-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-1 active:scale-95 transition-all">
                    <i class="fas fa-file-pdf text-xl"></i>
                    <span class="text-[8px] uppercase">PDF</span>
                </button>
                <button onclick="saveAndSendWhatsapp()" class="col-span-3 bg-[#00A650] hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-xl flex items-center justify-center gap-2 text-lg active:scale-95 transition-all">
                    <i class="fab fa-whatsapp text-2xl"></i>
                    <span>Enviar Pedido</span>
                </button>
            </div>
            
            <p class="text-[10px] text-gray-400 text-center mt-3 px-4">Qualquer item pode ser ajustado antes do faturamento.</p>
        </div>
    </div>

    <!-- Modal Dashboard -->
    <div id="dashboard-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-[70] flex items-center justify-center transition-opacity p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-slide-up relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeDashboard()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><i class="fas fa-times"></i></button>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-1">Dashboard</h2>
            <p class="text-xs text-gray-500 mb-6 uppercase tracking-wider font-bold">Visão Geral do Pedido Atual</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase">Itens Totais</p>
                    <p class="text-2xl font-black text-blue-800" id="dash-total-items">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <p class="text-[10px] text-green-600 font-bold uppercase">Economia Total</p>
                    <p class="text-2xl font-black text-green-800" id="dash-total-savings">R$ 0,00</p>
                </div>
            </div>

            <div class="mb-6">
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                 <p class="text-[10px] text-gray-500 font-bold uppercase mb-2">Resumo por Marca</p>
                 <div id="brand-summary-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal Calculadora de Margem -->
    <div id="calc-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up relative">
            <button onclick="closeCalc()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-calculator text-blue-600"></i> Calculadora de Margem de Lucro
            </h3>

            <div id="calc-fraction-toggle" class="hidden mb-4 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                <p class="text-[10px] font-bold text-yellow-700 uppercase mb-2 text-center">Tipo de Venda</p>
                <div class="flex bg-white rounded-lg p-1 border border-yellow-100 shadow-sm">
                    <button onclick="setCalcMode('box')" id="btn-calc-box" class="flex-1 py-1.5 text-[10px] font-bold rounded bg-yellow-400 text-white shadow-sm transition-all">Caixa Fechada</button>
                    <button onclick="setCalcMode('unit')" id="btn-calc-unit" class="flex-1 py-1.5 text-[10px] font-bold rounded text-gray-500 hover:bg-gray-50 transition-all">Por Unidade</button>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1" id="label-calc-cost">Custo do Produto (R$)</label>
                    <input type="number" id="calc-cost" class="w-full bg-gray-100 rounded-lg p-3 font-bold text-gray-700 outline-none" readonly>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1" id="label-calc-sell">Preço de Venda (R$)</label>
                    <input type="number" id="calc-sell" oninput="calculateMargin()" class="w-full bg-white border-2 border-blue-100 focus:border-blue-500 rounded-lg p-3 font-bold text-gray-800 outline-none" placeholder="0.00">
                </div>

                <div class="bg-gray-900 text-white p-4 rounded-xl text-center mt-2">
                    <p class="text-[10px] opacity-70 uppercase tracking-widest font-bold">Margem de Lucro</p>
                    <p class="text-3xl font-black" id="calc-result">0.0%</p>
                    <p class="text-xs opacity-70 mt-1" id="calc-profit-val">Lucro: R$ 0,00</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico -->
    <div id="history-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-slide-up relative max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Histórico de Pedidos</h3>
                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="history-list" class="overflow-y-auto flex-1 space-y-3">
                <!-- Injetado via JS -->
            </div>
             <button onclick="clearHistory()" class="mt-4 text-xs text-red-500 font-bold uppercase w-full text-center hover:underline">Limpar Histórico</button>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------
        // SEÇÃO 1: CONSTANTES E CONFIGURAÇÕES GLOBAIS
        // ------------------------------------------------------------
        const WHATSAPP_NUMBER = "5584996887483";
        const MIN_ORDER = 150.00;
        const IMG_DEFAULT = "https://cdn-icons-png.flaticon.com/512/883/883407.png";
        
        // Mapeamento de imagens
        const imgMap = {
            'Dorflex 24 Cpr': "https://www.drogarianovaesperanca.com.br/imagens/600x600/dorflex-com-24-comprimidos-132d4455b6.jpg",
            'Dorflex 300 Cpr': "https://nexodata.vtexassets.com/arquivos/ids/207705/7891058017392_IR.jpg",
            'Dorflex 36 Cpr': "https://drogaleste.vtexassets.com/arquivos/ids/292558/dorflex-36-comprimidos-7891058017507.png",
            'Dorflex 50 Cpr': "https://drogal.vtexassets.com/arquivos/ids/258828/141148.jpg?v=638884444466730000",
            'Dorflex Dip 1g – 10 Cpr': "https://cdn.awsli.com.br/223/223578/produto/235126215/dorflex-dip-qmfr1t4yol.jpg",
            'Dorflex Gotas 20ml': "https://drogariacristal.com/media/catalog/product/cache/eebd5eeb520c2fdd7e0cb6309d6623ed/d/o/dorflex_dipirona_s_dica_solu_o_gotas_20ml.jpg",
            'Dorflex Max 16 Cpr': "https://www.drogarianovaesperanca.com.br/imagens/600x600/dorflex-max-com-16-comprimidos-a46bdf272b.jpg",
            'Dorflex Max 8 Cpr': "https://www.dorflex.com.br/dam/jcr:4aaf2529-e889-435d-8437-6a5ef4fb39fe/DorflexMAX.webp",
            'Dorflex Max 80 Cpr': "https://www.dorflex.com.br/dam/jcr:4aaf2529-e889-435d-8437-6a5ef4fb39fe/DorflexMAX.webp",
            'Dorflex Uno 1g – 10 Cpr Eferv.': "https://www.drogaraia.com.br/_next/image?url=https%3A%2F%2Fproduct-data.raiadrogasil.io%2Fimages%2F15284138.webp&w=3840&q=40",
            'Dorflex Uno 1g – 10 Cpr': "https://drogariacristal.com/media/catalog/product/cache/eebd5eeb520c2fdd7e0cb6309d6623ed/d/o/dorflex_uno_dipirona_monoidratada_1g_10_comprimidos.jpg",
            'Dorflex Uno 1g – 20 Cpr': "https://images.tcdn.com.br/img/img_prod/740081/dorflex_uno_enxaqueca_1g_20_capsulas_6479_1_6060033b355f9efa2a86e8d5902b22f4.png",
            'Dorflex Uno 1g – 100 Cpr': "https://drogariacristal.com/media/catalog/product/cache/eebd5eeb520c2fdd7e0cb6309d6623ed/d/o/dorflex_uno_dipirona_monoidratada_1g_10_comprimidos.jpg",
            'Enterogermina 2 BCFU 10 flac': "https://drogariavenancio.vtexassets.com/arquivos/ids/1292459/25238_Z.jpg",
            'Enterogermina 2 BCFU 20 flac': "https://paguemenos.vtexassets.com/arquivos/ids/1103958/7891058017002_1.jpg",
            'Enterogermina 2 BCFU 5 flac': "https://paguemenos.vtexassets.com/arquivos/ids/1103975-1200-auto",
            'Enterogermina Plus 4 BCFU 10 flac': "https://m.media-amazon.com/images/I/71r4i-HCqGL._AC_UF1000,1000_QL80_.jpg",
            'Enterogermina Plus 4 BCFU 5 flac': "https://product-data.raiadrogasil.io/images/17667428.webp",
            'Enterogermina Adulto 2g 9 Sachês': "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQGZV655ug4hQejl62VRSUniDANYTRRUnp4bQ&s",
            'Allegra Pediátrico Susp 60ml': "https://www.drogariaminasbrasil.com.br/media/catalog/product/cache/74c1057f7991b4edb2bc7bdaa94de933/image/1030192909/allegra-pediatrico-cloridrato-de-fexofenadina-6mg-ml-sabor-framboesa-suspensao-oral-com-60ml.jpg",
            'Allegra 120mg – 10 Cpr': "https://paguemenos.vtexassets.com/arquivos/ids/1066985/7891058168049%20-%20Antialergico%20Allegra%C2%AE%20120mg%20com%2010%20comprimidos.png",
            'Allegra 120mg – 2 Cpr': "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR2nDKghtEDUT7dM9tRUk9zjdXtF5n9oM44WQ&s",
            'Allegra 120mg – 20 Cpr': "https://io.convertiez.com.br/m/drogalider/shop/products/images/40248/large/allegra-120mg-20-comprimidos-revestidos_28866.jpg",
            'Allegra 180mg – 10 Cpr': "https://paguemenos.vtexassets.com/arquivos/ids/1066986-800-auto",
            'Allegra 60mg – 10 Cpr': "https://uploads.consultaremedios.com.br/product_variation_images/full/8824a864059a51fda4f20328bb36e9705fed4bb8.jpg",
            'Allegra D – 10 Cpr': "https://drogafuji.vtexassets.com/arquivos/ids/186607-1200-auto",
            'Allegra Pediátrico 6mg/ml – Cup 60ml': "https://paguemenos.vtexassets.com/arquivos/ids/1017629/allegra-pediatrico-6mg-ml-frasco-60ml-com-copo-dosador-principal.jpg",
            'Allegra Pediátrico Susp 150ml': "https://cdn.ultrafarma.com.br/static/produtos/793316/large-638647684144433963-793316_2.jpg",
            'Allegra Pediátrico Cup 150ml': "https://drogariasp.vteximg.com.br/arquivos/ids/1302887-1000-1000/812188---Allegra-6mg-mL-Sanofi-1-Frasco-com-150mL-de-Suspensao-Oral---Copo-Dosador-1.jpg",
            'Novalgina 1g – 10 Cpr Efervescente': "https://www.drogarianovaesperanca.com.br/imagens/600x600/novalgina-1g-efervescente-com-10-comprimidos-5b9f4357c4.jpg",
            'Novalgina 1g – 10 Cpr Oco': "https://drogariaspacheco.vteximg.com.br/arquivos/ids/1383739-1000-1000/172545-Analgesico-Novalgina-1g-10-Comprimidos-2.jpg.jpg",
            'Novalgina 1g – 20 Cpr': "https://www.drogarianovaesperanca.com.br/imagens/600x600/novalgina-1g-com-20-comprimidos-1055fda3c5.jpg",
            'Novalgina 1g – 100 Cpr': "https://drogariaspacheco.vteximg.com.br/arquivos/ids/1383739-1000-1000/172545-Analgesico-Novalgina-1g-10-Comprimidos-2.jpg.jpg",
            'Novalgina 1g – 100 Cpr Eferv. (Display)': "https://www.drogarianovaesperanca.com.br/imagens/600x600/novalgina-1g-efervescente-com-10-comprimidos-5b9f4357c4.jpg",
            'Novalgina 300mg Supos – Bl5': "https://paguemenos.vtexassets.com/arquivos/ids/1052133/7891058467098-NovalginaSupositorio300mg-1.jpg?v=638900162060700000",
            'Novalgina 500mg – 30 Cpr Oco': "https://drogariaspacheco.vteximg.com.br/arquivos/ids/1278901-1000-1000/66893---Analgesico-Novalgina-500mg-Sanofi-30-Comprimidos_0004_7891058008635_2.png",
            'Novalgina 500mg – 240 Cpr': "https://farmaindex.com/_next/image?url=https%3A%2F%2Fik.imagekit.io%2FFarmaindex%2Ftr%3Aw-350%2Ch-350%2Fmedicine%2F47653.jpg&w=3840&q=75",
            'Novalgina Sol Oral 100ml + Seringa': "https://drogariavenancio.vtexassets.com/arquivos/ids/1149800/12232_z.jpg?v=638526046386870000",
            'Novalgina Cup Xarope 100ml': "https://product-data.raiadrogasil.io/images/6760217.webp",
            'Novalgina Gotas 10ml': "https://drogariavenancio.vtexassets.com/arquivos/ids/1149813/77472_z.jpg",
            'Novalgina Gotas 20ml': "https://uploads.consultaremedios.com.br/product_variation_images/full/a1ac4d2e70eeb0dfee016f9603722ab0806aaa7c.jpg",
            'Anador 1g – 10 Cpr': "https://product-data.raiadrogasil.io/images/12780090.webp",
            'Anador 1g – 20 Cpr': "https://product-data.raiadrogasil.io/images/12780196.webp",
            'Anador 1g – 80 Cpr': "https://www.drogaraia.com.br/_next/image?url=https%3A%2F%2Fproduct-data.raiadrogasil.io%2Fimages%2F12780080.webp&w=3840&q=40",
            'Anador 500mg – 128 Cpr (Suz)': "https://promofarma.vtexassets.com/arquivos/ids/168106/7896886410834.jpg?v=637952133732100000",
            'Anador 500mg – 24 Cpr (Suz)': "https://promofarma.vtexassets.com/arquivos/ids/168106/7896886410834.jpg?v=637952133732100000",
            'Anador 500mg – 240 Cpr': "https://promofarma.vtexassets.com/arquivos/ids/168106/7896886410834.jpg?v=637952133732100000",
            'Anador 500mg – 512 Cpr': "https://promofarma.vtexassets.com/arquivos/ids/168106/7896886410834.jpg?v=637952133732100000",
            'Anador Gotas – 20ml': "https://product-data.raiadrogasil.io/images/12779636.webp",
            'Targifor C 1g Eferv – 16 Cpr': "https://drogal.vtexassets.com/arquivos/ids/231500/111298.jpg?v=638579413474370000",
            'Targifor C 30 Cpr Rev.': "https://du3hj28fogfli.cloudfront.net/Custom/Content/Products/50/71/50712_targifor-c-500mg-500mg-caixa-com-30-comprimidos-revestidos-p7891058004668_l1_637750680092241630.webp",
            'Targifor C 60 Cpr Rev.': "https://io.convertiez.com.br/m/farmaciasheroos/shop/products/images/91939/large/targifor-c-500mg-60cpr_54128.jpg",
            'Targifor Cewin 500mg 3×10 Cpr': "https://drogariasp.vteximg.com.br/arquivos/ids/1197276-1000-1000/725668-Vitamina-C-Cewin-500mg-com-30-Comprimidos-2.jpg.jpg?v=638743682880830000",
            'Targifor Te Protege 1g 10 Cpr': "https://farmaciasnissei.com.br/media/produtos/40124-2.webp",
            'Targifor Te Protege 20ml Gotas': "https://http2.mlstatic.com/D_NQ_NP_898896-MLA99592086534_122025-O.webp",
            'Pharmaton Imunidade A–Z – 30 Cpr': "https://drogariacoop.vtexassets.com/arquivos/ids/171412-800-auto?v=638423046259370000&width=800&height=auto&aspect=true",
            'Pharmaton Imunidade A–Z – 60 Cpr': "https://drogariasp.vteximg.com.br/arquivos/ids/1197207/645338-Multivitaminico-Pharmaton-Complex-Sanofi-60-Capsulas.jpg.jpg?v=638743562664970000",
            'Pharmaton Mulher A-Z 30 Cpr': "https://drogariavenancio.vtexassets.com/arquivos/ids/1208090-800-450?v=638693563472030000&width=800&height=450&aspect=true",
            'Pharmaton Mulher A-Z 60 Cpr': "https://drogariaspacheco.vteximg.com.br/arquivos/ids/1380436-1000-1000/692948-Multivitaminico-Pharmaton-Mulher-Sanofi-60-Capsulas-1.jpg.jpg?v=638743568640900000",
            'Targifor Stress – 30 Cpr': "https://paguemenos.vtexassets.com/arquivos/ids/1052112-800-auto?v=638900161927900000&width=800&height=auto&aspect=true",
            'Targifor TPM – 15 Cpr': "https://www.targifor.com.br/Content/dist/img/new-pdp/MOCKUP-TARGIFOR-TPM-15-3-4-POTE-AF-V3.png",
            'Targifor Te Energiza – 30 Cpr': "https://drogal.vtexassets.com/arquivos/ids/266738/180403.jpg?v=638932952134000000",
            'Targifor Te Energiza – 60 Cpr': "https://drogal.vtexassets.com/arquivos/ids/266733/180398.jpg?v=638932950949330000",
            'Colírio Moura – 20ml': "https://product-data.raiadrogasil.io/images/3445787.webp",
            'Oscal 500mg – 60 Cpr': "https://product-data.raiadrogasil.io/images/12849235.webp",
            'Oscal D 500mg + 400UI – 60 Cpr': "https://drogal.vtexassets.com/arquivos/ids/248342/129474.jpg?v=638754182628730000",
            'Oscal D 500mg + 1000UI – 60 Cpr': "https://drogariasp.vteximg.com.br/arquivos/ids/1197239-1000-1000/692328-calcio-com-vitamina-d-os-cal-d-500mg--1000ui-60-comprimidos-3.jpg.jpg?v=638743567647870000",
            'Oscal Vitamina D 500ui/Gota 10ml': "https://http2.mlstatic.com/D_NQ_NP_960757-MLB90230180362_082025-O.webp",
            'Dulcolax 5mg – 20 Drágeas': "https://product-data.raiadrogasil.io/images/17667435.webp",
            'Dulcolax Gotas – 30ml': "https://drogal.vtexassets.com/arquivos/ids/248309/129441.jpg?v=638754143783800000",
            'Guttalax Gotas – 30ml': "https://www.drogariaminasbrasil.com.br/media/webp/catalog/product/cache/74c1057f7991b4edb2bc7bdaa94de933/image/58634e574/laxante-guttalax-gotas-7-5mg-ml-30-ml_jpg.webp",
            'Bisolvon Xarope Ped 4mg/5ml 120ml': "https://drogariaglobo.vtexassets.com/arquivos/ids/1143896-800-450?v=638899942544900000&width=800&height=450&aspect=true",
            'Bisolvon XPE 8mg/5ml Adulto 120ml': "https://drogal.vtexassets.com/arquivos/ids/231765/111565.jpg?v=638580905439800000",
            'Bisolvon 2mg/ml Sol Expec 40ml': "https://farmadelivery.fbitsstatic.net/img/p/bisolvon-gotas-expectorante-2mg-ml-50ml-183723/370274.jpg?w=588&h=502&v=no-value",
            'Mucosolvan Xarope Ad 30mg/5ml 120ml': "https://drogal.vtexassets.com/arquivos/ids/258302/140544.jpg?v=638882600659300000",
            'Mucosolvan Xarope Ped 15mg/5ml 120ml': "https://drogariasp.vteximg.com.br/arquivos/ids/651896-1000-1000/17728---xarope-mucosolvan-15mg5ml-pediatrico-120ml.jpg?v=637892556615870000",
            'Cremefenergan – 30g': "https://paguemenos.vtexassets.com/arquivos/ids/982310/fenergan-creme-30g-principal.jpg?v=638745480067870000",
            'Fenergan 25mg – 20 Cpr': "https://d1jgmae0hcnr1i.cloudfront.net/Custom/Content/Products/91/86/91867_fenergan-25mg-c-20cpr-p63251_m1_638287309011566752.webp",
            'Fenergan 50mg – 25 Amp': "https://phygital-files.mercafacil.com/essencyalfarma/uploads/produto/fenergan_25mg_inj_cx_25_amp_x_2ml_86a5bb5e-957d-49ea-920a-b0a29f01bf36.png"
        };

        // ------------------------------------------------------------
        // SEÇÃO 2: FUNÇÕES AUXILIARES (GLOBALMENTE DISPONÍVEIS)
        // ------------------------------------------------------------
        function getCardStyle(cat) {
            const styles = {
                'Dorflex': 'card-dorflex', 'Enterogermina': 'card-entero', 'Allegra': 'card-allegra', 
                'Novalgina': 'card-novalgina', 'Anador': 'card-anador', 'Targifor': 'card-targifor', 
                'Moura': 'card-moura', 'Oscal': 'card-oscal', 'Dulco': 'card-dulco', 
                'Bisolvon': 'card-bisolvon', 'Fenergan': 'card-fenergan'
            };
            return styles[cat] || 'bg-white';
        }

        function getTextStyle(cat) {
            const styles = {
                'Dorflex': 'text-dorflex', 'Enterogermina': 'text-entero', 'Allegra': 'text-allegra', 
                'Novalgina': 'text-novalgina', 'Anador': 'text-anador', 'Targifor': 'text-targifor', 
                'Moura': 'text-moura', 'Oscal': 'text-oscal', 'Dulco': 'text-dulco', 
                'Bisolvon': 'text-bisolvon', 'Fenergan': 'text-fenergan'
            };
            return styles[cat] || 'text-gray-800';
        }

        function getBadgeStyle(cat) {
            const styles = {
                'Dorflex': 'btn-dorflex-active', 'Enterogermina': 'btn-enterogermina-active', 'Allegra': 'btn-allegra-active', 
                'Novalgina': 'btn-novalgina-active', 'Anador': 'btn-anador-active', 'Targifor': 'btn-targifor-active', 
                'Moura': 'btn-moura-active', 'Oscal': 'btn-oscal-active', 'Dulco': 'btn-dulco-active', 
                'Bisolvon': 'btn-bisolvon-active', 'Fenergan': 'btn-fenergan-active'
            };
            return styles[cat] || 'bg-gray-800 text-white';
        }

        function getPrice(p, qty) {
            if (!p || !p.tiers) return 0; // Proteção contra produto indefinido
            const tier = [...p.tiers].reverse().find(t => qty >= t.q);
            return tier ? tier.p : p.tiers[0].p;
        }

        function getNextTierHint(p, qty) {
            if (!p || !p.tiers || qty <= 0) return null;
            
            for (let i = 0; i < p.tiers.length; i++) {
                if (qty < p.tiers[i].q) {
                    const falta = p.tiers[i].q - qty;
                    const economia = ((p.tiers[Math.max(0, i-1)].p - p.tiers[i].p) * p.tiers[i].q).toFixed(2);
                    return {
                        falta: falta,
                        tierQty: p.tiers[i].q,
                        desconto: p.tiers[i].d,
                        economia: economia
                    };
                }
            }
            return null;
        }

        // ------------------------------------------------------------
        // SEÇÃO 3: DADOS DE PRODUTOS
        // ------------------------------------------------------------
        const rawProducts = [
            // DORFLEX
            { id: "7891058022136", cat: 'Dorflex', name: 'Dorflex 24 Cpr', base: 14.91, tiers: [ {q:1, p:13.87, d:7}, {q:4, p:13.57, d:9}, {q:8, p:13.27, d:11} ] },
            { id: "7891058017392", cat: 'Dorflex', name: 'Dorflex 300 Cpr', base: 194.96, tiers: [ {q:1, p:177.41, d:9}, {q:2, p:173.51, d:11}, {q:4, p:169.62, d:13} ], fraction: { unit: 'Cartela (10un)', divisor: 30 } },
            { id: "7891058017507", cat: 'Dorflex', name: 'Dorflex 36 Cpr', base: 19.06, tiers: [ {q:1, p:17.54, d:8}, {q:30, p:17.15, d:10}, {q:60, p:16.77, d:12} ] },
            // Removed Dorflex 50 Cpr as requested
            { id: "7891058005474", cat: 'Dorflex', name: 'Dorflex Dip 1g – 10 Cpr', base: 13.31, tiers: [ {q:1, p:11.71, d:12}, {q:10, p:9.32, d:30}, {q:20, p:7.32, d:45} ] },
            { id: "7891058009458", cat: 'Dorflex', name: 'Dorflex Gotas 20ml', base: 21.05, tiers: [ {q:1, p:18.95, d:10} ] },
            { id: "7891058003975", cat: 'Dorflex', name: 'Dorflex Max 16 Cpr', base: 24.36, tiers: [ {q:1, p:22.41, d:8}, {q:3, p:21.19, d:13}, {q:4, p:20.46, d:16} ] },
            { id: "7891058003944", cat: 'Dorflex', name: 'Dorflex Max 8 Cpr', base: 13.50, tiers: [ {q:1, p:12.42, d:8}, {q:4, p:11.75, d:13}, {q:8, p:11.34, d:16} ] },
            { id: "7891058003937", cat: 'Dorflex', name: 'Dorflex Max 80 Cpr', base: 151.01, tiers: [ {q:1, p:135.91, d:10}, {q:2, p:132.89, d:12}, {q:3, p:129.87, d:14} ], fraction: { unit: 'Cartela (4un)', divisor: 20 } },
            { id: "7891058022792", cat: 'Dorflex', name: 'Dorflex Uno 1g – 10 Cpr Eferv.', base: 26.50, tiers: [ {q:1, p:23.59, d:11} ] },
            { id: "7891058022815", cat: 'Dorflex', name: 'Dorflex Uno 1g – 10 Cpr', base: 14.83, tiers: [ {q:1, p:13.79, d:7}, {q:3, p:13.20, d:11}, {q:6, p:13.05, d:12} ] },
            { id: "7891058000103", cat: 'Dorflex', name: 'Dorflex Uno 1g – 20 Cpr', base: 24.01, tiers: [ {q:1, p:22.33, d:7}, {q:3, p:21.37, d:11}, {q:4, p:21.13, d:12} ] },
            { id: "7891058022785", cat: 'Dorflex', name: 'Dorflex Uno 1g – 100 Cpr', base: 172.06, tiers: [ {q:1, p:151.41, d:12} ], fraction: { unit: 'Cartela (4un)', divisor: 25 } },

            // ENTEROGERMINA (PREÇOS ATUALIZADOS)
            { id: "7891058016999", cat: 'Enterogermina', name: 'Enterogermina 2 BCFU 10 flac', base: 43.05, tiers: [ {q:1, p:38.31, d:11}, {q:6, p:36.59, d:15}, {q:14, p:35.73, d:17}, {q:30, p:31.86, d:26}, {q:40, p:30.14, d:30} ], isCampaign: true },
            { id: "7891058017002", cat: 'Enterogermina', name: 'Enterogermina 2 BCFU 20 flac', base: 68.11, tiers: [ {q:1, p:60.62, d:11}, {q:3, p:57.89, d:15}, {q:4, p:56.53, d:17}, {q:10, p:50.40, d:26}, {q:15, p:47.68, d:30} ], isCampaign: true },
            { id: "7891058006501", cat: 'Enterogermina', name: 'Enterogermina 2 BCFU 5 flac', base: 28.67, tiers: [ {q:1, p:25.52, d:11}, {q:3, p:24.37, d:15}, {q:4, p:23.80, d:17}, {q:10, p:21.22, d:26}, {q:15, p:20.07, d:30} ], isCampaign: true },
            { id: "7891058022594", cat: 'Enterogermina', name: 'Enterogermina Plus 4 BCFU 10 flac', base: 70.09, tiers: [ {q:1, p:62.38, d:11}, {q:3, p:59.58, d:15}, {q:4, p:58.17, d:17}, {q:10, p:51.87, d:26}, {q:15, p:49.06, d:30} ], isCampaign: true },
            { id: "7891058020286", cat: 'Enterogermina', name: 'Enterogermina Plus 4 BCFU 5 flac', base: 44.29, tiers: [ {q:1, p:39.42, d:11}, {q:5, p:37.65, d:15}, {q:10, p:36.76, d:17}, {q:18, p:32.77, d:26}, {q:30, p:31.00, d:30} ], isCampaign: true },
            { id: "7891058001988", cat: 'Enterogermina', name: 'Enterogermina Adulto 2g 9 Sachês', base: 56.01, tiers: [ {q:1, p:47.05, d:16} ] },

            // ALLEGRA
            { id: "7891058004347", cat: 'Allegra', name: 'Allegra Pediátrico Susp 60ml', base: 30.64, tiers: [ {q:1, p:28.19, d:8}, {q:3, p:27.58, d:10}, {q:6, p:26.96, d:12} ] },
            { id: "7891058168049", cat: 'Allegra', name: 'Allegra 120mg – 10 Cpr', base: 45.76, tiers: [ {q:1, p:42.56, d:7}, {q:2, p:41.64, d:9}, {q:3, p:40.73, d:11} ] },
            { id: "7891058002596", cat: 'Allegra', name: 'Allegra 120mg – 2 Cpr', base: 14.56, tiers: [ {q:1, p:13.10, d:10} ] },
            { id: "7891058002701", cat: 'Allegra', name: 'Allegra 120mg – 20 Cpr', base: 82.45, tiers: [ {q:1, p:74.21, d:10} ] },
            { id: "7891058169015", cat: 'Allegra', name: 'Allegra 180mg – 10 Cpr', base: 68.70, tiers: [ {q:1, p:61.83, d:10} ] },
            { id: "7891058024314", cat: 'Allegra', name: 'Allegra 60mg – 10 Cpr', base: 22.85, tiers: [ {q:1, p:21.25, d:7}, {q:2, p:20.79, d:9}, {q:3, p:20.34, d:11} ] },
            { id: "7891058006716", cat: 'Allegra', name: 'Allegra D – 10 Cpr', base: 55.74, tiers: [ {q:1, p:51.84, d:7}, {q:2, p:50.72, d:9}, {q:3, p:49.61, d:11} ] },
            { id: "7891058002589", cat: 'Allegra', name: 'Allegra Pediátrico 6mg/ml – Cup 60ml', base: 30.64, tiers: [ {q:1, p:28.50, d:7}, {q:3, p:27.88, d:9}, {q:6, p:27.27, d:11} ] },
            { id: "7891058004354", cat: 'Allegra', name: 'Allegra Pediátrico Susp 150ml', base: 69.56, tiers: [ {q:1, p:64.00, d:8}, {q:3, p:62.60, d:10}, {q:4, p:61.21, d:12} ] },
            { id: "7891058002572", cat: 'Allegra', name: 'Allegra Pediátrico Cup 150ml', base: 69.56, tiers: [ {q:1, p:62.60, d:10} ] },

            // NOVALGINA (Campanha - Destaques + Flash)
            { id: "7891058015756", cat: 'Novalgina', name: 'Novalgina 1g – 10 Cpr Efervescente', base: 28.74, tiers: [ {q:1, p:25.58, d:11}, {q:6, p:24.43, d:15}, {q:12, p:23.28, d:19} ], isCampaign: true },
            { id: "7891058001155", cat: 'Novalgina', name: 'Novalgina 1g – 10 Cpr Oco', base: 19.68, tiers: [ {q:1, p:18.11, d:8}, {q:6, p:17.71, d:10}, {q:12, p:17.32, d:12}, {q:24, p:15.94, d:19}, {q:40, p:15.15, d:23} ], isCampaign: true },
            { id: "7891058002565", cat: 'Novalgina', name: 'Novalgina 1g – 20 Cpr', base: 35.93, tiers: [ {q:1, p:33.41, d:7}, {q:4, p:32.70, d:9}, {q:6, p:31.98, d:11} ] },
            { id: "7891058011222", cat: 'Novalgina', name: 'Novalgina 1g – 100 Cpr', base: 249.03, tiers: [ {q:1, p:221.64, d:11}, {q:3, p:201.71, d:19} ], isCampaign: true, fraction: { unit: 'Cartela (4un)', divisor: 25 } },
            { id: "7891058015770", cat: 'Novalgina', name: 'Novalgina 1g – 100 Cpr Eferv. (Display)', base: 299.94, tiers: [ {q:1, p:266.95, d:11} ], fraction: { unit: 'Env (2un)', divisor: 50 } },
            { id: "7891058467098", cat: 'Novalgina', name: 'Novalgina 300mg Supos – Bl5', base: 18.63, tiers: [ {q:1, p:16.95, d:9} ] },
            { id: "7891058008635", cat: 'Novalgina', name: 'Novalgina 500mg – 30 Cpr Oco', base: 35.86, tiers: [ {q:1, p:32.63, d:9} ] },
            { id: "7891058008642", cat: 'Novalgina', name: 'Novalgina 500mg – 240 Cpr', base: 323.54, tiers: [ {q:1, p:294.42, d:9} ], fraction: { unit: 'Cartela (10un)', divisor: 24 } },
            { id: "7891058464073", cat: 'Novalgina', name: 'Novalgina Sol Oral 100ml + Seringa', base: 37.46, tiers: [ {q:1, p:34.46, d:8}, {q:3, p:33.71, d:10}, {q:5, p:32.96, d:12}, {q:8, p:29.59, d:21}, {q:12, p:26.97, d:28} ], isCampaign: true },
            { id: "7891058005566", cat: 'Novalgina', name: 'Novalgina Cup Xarope 100ml', base: 37.46, tiers: [ {q:1, p:34.84, d:7}, {q:3, p:33.71, d:10}, {q:4, p:33.34, d:11}, {q:6, p:30.34, d:19} ], isCampaign: true },
            { id: "7891058000172", cat: 'Novalgina', name: 'Novalgina Gotas 10ml', base: 13.48, tiers: [ {q:1, p:12.54, d:7}, {q:3, p:12.27, d:9}, {q:4, p:12.00, d:11}, {q:6, p:10.38, d:23} ], isCampaign: true },
            { id: "7891058000165", cat: 'Novalgina', name: 'Novalgina Gotas 20ml', base: 24.79, tiers: [ {q:1, p:23.05, d:7}, {q:3, p:22.56, d:9}, {q:6, p:22.06, d:11}, {q:8, p:19.09, d:23} ], isCampaign: true },
            
            // Novalgina Flash (Pré-Pedido)
            { id: "7891058005993", cat: 'Novalgina', name: 'Novalgina Flash 8 Cpr (Pré-Pedido)', base: 19.71, tiers: [ {q:1, p:18.13, d:8}, {q:4, p:17.94, d:9}, {q:8, p:17.54, d:11}, {q:15, p:15.97, d:19}, {q:30, p:15.18, d:23}, {q:120, p:11.83, d:40} ], isCampaign: true, image: "https://drogariasp.vteximg.com.br/arquivos/ids/1614175-176-176/909530---Analgesico-Novalgina-Flash-1g-130mg-8-Comprimidos-1.jpg?v=639052175863030000" },
            { id: "7891058006044", cat: 'Novalgina', name: 'Novalgina Flash 16 Cpr (Pré-Pedido)', base: 35.93, tiers: [ {q:1, p:33.06, d:8}, {q:3, p:32.70, d:9}, {q:6, p:31.98, d:11}, {q:12, p:29.10, d:19}, {q:84, p:21.56, d:40} ], isCampaign: true, image: "https://drogariasp.vteximg.com.br/arquivos/ids/1614175-176-176/909530---Analgesico-Novalgina-Flash-1g-130mg-8-Comprimidos-1.jpg?v=639052175863030000" },

            // ANADOR
            { id: "7891058003890", cat: 'Anador', name: 'Anador 1g – 10 Cpr', base: 13.00, tiers: [ {q:1, p:10.79, d:17}, {q:60, p:8.45, d:35}, {q:120, p:7.15, d:45} ] },
            { id: "7891058003883", cat: 'Anador', name: 'Anador 1g – 20 Cpr', base: 23.40, tiers: [ {q:1, p:19.89, d:15}, {q:60, p:15.21, d:35}, {q:120, p:12.87, d:45} ] },
            { id: "7891058003913", cat: 'Anador', name: 'Anador 1g – 80 Cpr', base: 110.79, tiers: [ {q:1, p:90.85, d:18} ], fraction: { unit: 'Cartela (4un)', divisor: 20 } },
            { id: "7891058021672", cat: 'Anador', name: 'Anador 500mg – 128 Cpr (Suz)', base: 142.10, tiers: [ {q:1, p:132.15, d:7} ], fraction: { unit: 'Cartela (4un)', divisor: 32 } },
            { id: "7891058021597", cat: 'Anador', name: 'Anador 500mg – 24 Cpr (Suz)', base: 22.91, tiers: [ {q:1, p:20.16, d:12}, {q:60, p:14.89, d:35}, {q:120, p:12.60, d:45} ] },
            { id: "7891058021665", cat: 'Anador', name: 'Anador 500mg – 240 Cpr', base: 266.48, tiers: [ {q:1, p:210.52, d:21} ], fraction: { unit: 'Cartela (4un)', divisor: 60 } },
            { id: "7891058021603", cat: 'Anador', name: 'Anador 500mg – 512 Cpr', base: 567.95, tiers: [ {q:1, p:528.19, d:7} ], fraction: { unit: 'Cartela (4un)', divisor: 128 } },
            { id: "7891058021580", cat: 'Anador', name: 'Anador Gotas – 20ml', base: 21.68, tiers: [ {q:1, p:19.08, d:12} ] },

            // TARGIFOR / CEWIN / PHARMATON (PREÇOS ATUALIZADOS)
            { id: "7891058005467", cat: 'Targifor', name: 'Targifor C 1g Eferv – 16 Cpr', base: 32.83, tiers: [ {q:1, p:29.55, d:10}, {q:4, p:27.91, d:15}, {q:8, p:26.26, d:20} ] },
            { id: "7891058004668", cat: 'Targifor', name: 'Targifor C 30 Cpr Rev.', base: 54.91, tiers: [ {q:1, p:49.97, d:9} ] },
            { id: "7891058004675", cat: 'Targifor', name: 'Targifor C 60 Cpr Rev.', base: 92.71, tiers: [ {q:1, p:84.37, d:9} ] },
            { id: "7891058000295", cat: 'Targifor', name: 'Targifor Cewin 500mg 3×10 Cpr', base: 32.75, tiers: [ {q:1, p:30.46, d:7}, {q:3, p:29.80, d:9}, {q:4, p:29.15, d:11} ] },
            { id: "7891058001520", cat: 'Targifor', name: 'Targifor Te Protege 1g 10 Cpr', base: 15.82, tiers: [ {q:1, p:14.71, d:7}, {q:3, p:14.40, d:9}, {q:4, p:14.08, d:11} ] },
            { id: "7891058001643", cat: 'Targifor', name: 'Targifor Te Protege 20ml Gotas', base: 17.51, tiers: [ {q:1, p:16.28, d:7}, {q:3, p:15.93, d:9}, {q:4, p:15.58, d:11} ] },
            { id: "7891058021726", cat: 'Targifor', name: 'Pharmaton Imunidade A–Z – 30 Cpr', base: 61.55, tiers: [ {q:1, p:47.39, d:23} ] },
            { id: "7891058021702", cat: 'Targifor', name: 'Pharmaton Imunidade A–Z – 60 Cpr', base: 111.01, tiers: [ {q:1, p:85.48, d:23} ] },
            { id: "7891058022693", cat: 'Targifor', name: 'Pharmaton Mulher A-Z 30 Cpr', base: 70.04, tiers: [ {q:1, p:56.38, d:19.5} ] },
            { id: "7891058022686", cat: 'Targifor', name: 'Pharmaton Mulher A-Z 60 Cpr', base: 125.83, tiers: [ {q:1, p:101.29, d:19.5} ] },
            { id: "7891058006525", cat: 'Targifor', name: 'Targifor Stress – 30 Cpr', base: 41.30, tiers: [ {q:1, p:38.41, d:7}, {q:3, p:37.58, d:9}, {q:6, p:36.34, d:12} ] },
            { id: "7891058006518", cat: 'Targifor', name: 'Targifor TPM – 15 Cpr', base: 28.76, tiers: [ {q:1, p:26.75, d:7}, {q:3, p:26.17, d:9}, {q:6, p:25.31, d:12} ] },
            { id: "7891058005870", cat: 'Targifor', name: 'Targifor Te Energiza – 30 Cpr', base: 56.09, tiers: [ {q:1, p:51.04, d:9} ] },
            { id: "7891058005887", cat: 'Targifor', name: 'Targifor Te Energiza – 60 Cpr', base: 91.92, tiers: [ {q:1, p:83.65, d:9} ] },

            // MOURA BRASIL (Campanha - Destaque)
            { id: "7891058020316", cat: 'Moura', name: 'Colírio Moura – 20ml', base: 22.21, tiers: [ {q:1, p:20.66, d:7}, {q:5, p:20.21, d:9}, {q:10, p:19.77, d:11}, {q:12, p:17.55, d:21} ], isCampaign: true },

            // OSCAL (PREÇOS ATUALIZADOS)
            { id: "7891058002343", cat: 'Oscal', name: 'Oscal 500mg – 60 Cpr', base: 107.54, tiers: [ {q:1, p:97.86, d:9} ] },
            { id: "7891058002336", cat: 'Oscal', name: 'Oscal D 500mg + 400UI – 60 Cpr', base: 116.46, tiers: [ {q:1, p:105.98, d:9} ] },
            { id: "7891058022730", cat: 'Oscal', name: 'Oscal D 500mg + 1000UI – 60 Cpr', base: 117.66, tiers: [ {q:1, p:107.07, d:9} ] },
            { id: "7891058005788", cat: 'Oscal', name: 'Oscal Vitamina D 500ui/Gota 10ml', base: 71.81, tiers: [ {q:1, p:65.35, d:9} ] },

            // DULCOLAX / GUTTALAX
            { id: "7891058021528", cat: 'Dulco', name: 'Dulcolax 5mg – 20 Drágeas', base: 15.64, tiers: [ {q:1, p:14.23, d:9} ] },
            { id: "7891058001032", cat: 'Dulco', name: 'Dulcolax Gotas – 30ml', base: 30.19, tiers: [ {q:1, p:27.47, d:9} ] },
            { id: "7891058021689", cat: 'Dulco', name: 'Guttalax Gotas – 30ml', base: 36.08, tiers: [ {q:1, p:32.83, d:9} ] },

            // BISOLVON / MUCOSOLVAN
            { id: "7891058021627", cat: 'Bisolvon', name: 'Bisolvon Xarope Ped 4mg/5ml 120ml', base: 24.86, tiers: [ {q:1, p:21.13, d:15} ] },
            { id: "7891058021610", cat: 'Bisolvon', name: 'Bisolvon XPE 8mg/5ml Adulto 120ml', base: 30.38, tiers: [ {q:1, p:25.82, d:15} ] },
            { id: "7891058001810", cat: 'Bisolvon', name: 'Bisolvon 2mg/ml Sol Expec 40ml', base: 29.85, tiers: [ {q:1, p:24.48, d:18} ] },
            { id: "7891058021566", cat: 'Bisolvon', name: 'Mucosolvan Xarope Ad 30mg/5ml 120ml', base: 49.91, tiers: [ {q:1, p:42.42, d:15} ] },
            { id: "7891058021573", cat: 'Bisolvon', name: 'Mucosolvan Xarope Ped 15mg/5ml 120ml', base: 35.94, tiers: [ {q:1, p:30.55, d:15} ] },

            // FENERGAN
            { id: "7896070600249", cat: 'Fenergan', name: 'Cremefenergan – 30g', base: 22.31, tiers: [ {q:1, p:20.75, d:7}, {q:3, p:20.30, d:9}, {q:4, p:19.86, d:11} ] },
            { id: "7896070600447", cat: 'Fenergan', name: 'Fenergan 25mg – 20 Cpr', base: 15.26, tiers: [ {q:1, p:14.19, d:7}, {q:3, p:13.89, d:9}, {q:6, p:13.58, d:11} ] },
            { id: "7896070600485", cat: 'Fenergan', name: 'Fenergan 50mg – 25 Amp', base: 93.30, tiers: [ {q:1, p:84.90, d:9} ] }
        ];

        const products = rawProducts.map((p) => {
            let img = imgMap[p.name] || (p.image || IMG_DEFAULT);
            // Fallback para novos itens Anador sem imagem específica no mapa
            if (p.cat === 'Anador' && img === IMG_DEFAULT) {
                 img = "https://promofarma.vtexassets.com/arquivos/ids/168106/7896886410834.jpg?v=637952133732100000"; 
            }
            return {
                id: p.id,
                cat: p.cat,
                name: p.name,
                image: img,
                base: p.base,
                tiers: p.tiers,
                fraction: p.fraction,
                isCampaign: p.isCampaign || false // Propaga a flag de campanha
            };
        });

        // ------------------------------------------------------------
        // SEÇÃO 4: VARIÁVEIS DE ESTADO E FUNÇÕES PRINCIPAIS
        // ------------------------------------------------------------
        
        let cart = {}; 
        let currentCategory = 'all';
        let currentCalcProduct = null;
        let chartInstance = null;
        let calcMode = 'box'; 
        let orderHistory = JSON.parse(localStorage.getItem('opella_history')) || [];
        let favorites = JSON.parse(localStorage.getItem('opella_favorites')) || [];
        
        // === FAVORITOS ===
        function toggleFavorite(id) {
            const idx = favorites.indexOf(id);
            if (idx > -1) {
                favorites.splice(idx, 1);
            } else {
                favorites.push(id);
            }
            localStorage.setItem('opella_favorites', JSON.stringify(favorites));
            
            // Se estivermos na categoria favoritos ou campanha, re-renderizar
            if (currentCategory === 'favorites' || currentCategory === 'campaign') {
                render();
            } else {
                render(); // Render normal para atualizar o ícone
            }
        }
        
        function isFavorite(id) {
            return favorites.includes(id);
        }
        
        // === QUICK REORDER ===
        function getLastOrder() {
            return orderHistory.length > 0 ? orderHistory[0] : null;
        }
        
        function quickReorder() {
            const lastOrder = getLastOrder();
            if (lastOrder && lastOrder.cartSnapshot) {
                cart = JSON.parse(JSON.stringify(lastOrder.cartSnapshot));
                saveCart();
                render();
                // Feedback visual
                const bar = document.getElementById('quick-reorder-bar');
                if (bar) {
                    bar.innerHTML = '<i class="fas fa-check text-green-600"></i> <span class="text-green-700 font-bold text-xs">Pedido restaurado!</span>';
                    setTimeout(() => updateQuickReorderBar(), 2000);
                }
            }
        }
        
        function updateQuickReorderBar() {
            const container = document.getElementById('quick-reorder-container');
            if (!container) return;
            
            const lastOrder = getLastOrder();
            if (lastOrder) {
                container.innerHTML = `
                    <div id="quick-reorder-bar" class="quick-reorder-bar" onclick="quickReorder()">
                        <div class="w-9 h-9 bg-green-500 rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-redo text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-[11px] font-bold text-green-800">Repetir Último Pedido</p>
                            <p class="text-[9px] text-green-600">${lastOrder.itemsCount} itens • R$ ${lastOrder.total.toFixed(2).replace('.',',')} • ${lastOrder.date.split(',')[0]}</p>
                        </div>
                        <i class="fas fa-chevron-right text-green-400 text-sm"></i>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        window.onload = function() {
            // --- CORREÇÃO DE SEGURANÇA: SANITIZAÇÃO DO CARRINHO ---
            const savedCart = localStorage.getItem('opella_cart');
            if (savedCart) {
                try {
                    let loadedCart = JSON.parse(savedCart);
                    cart = {};
                    Object.keys(loadedCart).forEach(id => {
                        // Verifica se o ID existe na lista atual de produtos
                        if (products.some(p => p.id === id)) {
                            cart[id] = loadedCart[id];
                        }
                    });
                } catch(e) {
                    cart = {}; 
                }
            }
            // ------------------------------------------------------
            render();
            updateHistoryList();
            updateQuickReorderBar(); // Inicializa Quick Reorder
            
            // --- Lazy loading para imagens ---
            if ('IntersectionObserver' in window) {
                const imgObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            observer.unobserve(img);
                        }
                    });
                }, { rootMargin: '100px' });
                
                window.imgObserver = imgObserver;
            }
            
            const slider = document.getElementById('category-scroll');
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; 
                slider.scrollLeft = scrollLeft - walk;
            });
        };

        function setCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove(
                    'btn-dorflex-active', 'btn-enterogermina-active', 'btn-allegra-active', 
                    'btn-novalgina-active', 'btn-anador-active', 'btn-targifor-active', 
                    'btn-moura-active', 'btn-oscal-active', 'btn-dulco-active', 
                    'btn-bisolvon-active', 'btn-fenergan-active', 'btn-favorites-active', 'cat-btn-all-active', 'btn-campaign-active'
                );
            });

            const activeBtn = document.getElementById(cat === 'favorites' ? 'btn-favorites' : (cat === 'campaign' ? 'btn-campaign' : 'btn-' + cat));
            if(activeBtn) {
                if(cat === 'all') activeBtn.classList.add('cat-btn-all-active');
                else if (cat === 'favorites') activeBtn.classList.add('btn-favorites-active');
                else if (cat === 'campaign') activeBtn.classList.add('btn-campaign-active');
                else {
                    const activeClass = `btn-${cat.toLowerCase()}-active`;
                    activeBtn.classList.add(activeClass);
                }
            }
            render();
        }

        function render() {
            const container = document.getElementById('product-list');
            const searchInput = document.getElementById('search-input');
            const search = searchInput ? searchInput.value.toLowerCase() : "";
            
            // Se houver busca, ignoramos a categoria atual (comportamento padrão)
            // Se não houver busca, usamos a categoria selecionada (incluindo 'favorites' ou 'campaign')
            const effectiveCategory = (search.length > 0) ? 'all' : currentCategory;
            
            container.innerHTML = '';

            const filtered = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(search) || p.id.includes(search);
                
                let matchesCat = false;
                if (effectiveCategory === 'all') {
                    matchesCat = true;
                } else if (effectiveCategory === 'favorites') {
                    matchesCat = isFavorite(p.id);
                } else if (effectiveCategory === 'campaign') {
                    // Exibe APENAS os itens marcados como Campanha
                    matchesCat = p.isCampaign === true;
                } else {
                    matchesCat = p.cat === effectiveCategory;
                }

                return matchesSearch && matchesCat;
            });
            
            // Ordenação: Itens de campanha primeiro APENAS quando em 'campaign'
            // Quando em 'all', mantém a ordem original do array products (sequencial por marca)
            if (effectiveCategory === 'campaign') {
                 filtered.sort((a, b) => (b.isCampaign === true ? 1 : 0) - (a.isCampaign === true ? 1 : 0));
            }

            if(filtered.length === 0) {
                let msg = "Nada encontrado.";
                if (currentCategory === 'favorites' && search.length === 0) {
                    msg = "Você ainda não tem favoritos.";
                } else if (currentCategory === 'campaign' && search.length === 0) {
                    msg = "Nenhum produto da campanha encontrado.";
                }
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fas fa-box-open text-4xl mb-2"></i><p>${msg}</p></div>`; return;
            }

            let lastCat = '';

            filtered.forEach(p => {
                // Show category header if showing ALL, FAVORITES or CAMPAIGN (since they can be mixed)
                if((effectiveCategory === 'all' || effectiveCategory === 'favorites' || effectiveCategory === 'campaign') && p.cat !== lastCat) {
                    lastCat = p.cat;
                    const catHeader = document.createElement('div');
                    catHeader.className = `font-bold text-xs uppercase tracking-widest mt-8 mb-2 ml-1 ${getTextStyle(p.cat)} flex items-center gap-2`;
                    let badgeColorClass = getBadgeStyle(p.cat).split(' ')[0];
                    if(badgeColorClass.startsWith('text')) badgeColorClass = 'bg-gray-800'; 
                    catHeader.innerHTML = `<span class="w-1 h-4 ${badgeColorClass} rounded-full"></span> ${p.cat}`;
                    container.appendChild(catHeader);
                }

                const qty = cart[p.id] || 0;
                const currentPrice = getPrice(p, qty);
                const isPromo = currentPrice < p.tiers[0].p;
                const cardClass = getCardStyle(p.cat);
                const textClass = getTextStyle(p.cat);
                const badgeClass = getBadgeStyle(p.cat);

                const card = document.createElement('div');
                card.id = 'product-' + p.id; // Added ID for anchor scrolling
                card.className = `product-card p-4 rounded-xl shadow-sm border relative mb-3 ${cardClass}`;
                
                // Botão de Favorito
                const favClass = isFavorite(p.id) ? 'active' : '';
                
                // Hint do próximo tier
                const nextTier = getNextTierHint(p, qty);
                let nextTierHtml = '';
                if (nextTier && qty > 0) {
                    nextTierHtml = `
                        <div class="next-tier-hint">
                            <i class="fas fa-arrow-up"></i>
                            +${nextTier.falta} un → ${nextTier.desconto}% OFF
                        </div>
                    `;
                }
                
                // Lazy loading: usar data-src para imagens
                const imgHtml = window.imgObserver 
                    ? `<img data-src="${p.image}" class="w-full h-full object-contain mix-blend-multiply lazy-img" alt="${p.name}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'%3E%3C/svg%3E">`
                    : `<img src="${p.image}" class="w-full h-full object-contain mix-blend-multiply" alt="${p.name}">`;
                
                card.innerHTML = `
                    <button onclick="event.stopPropagation(); toggleFavorite('${p.id}')" class="favorite-btn ${favClass}" title="Favoritar">
                        <i class="fas fa-heart"></i>
                    </button>
                    <div class="flex gap-4 items-start">
                        <div class="w-20 h-20 flex-shrink-0 bg-white rounded-lg border border-white/50 p-1 flex items-center justify-center shadow-sm relative text-center">
                             ${p.isCampaign ? '<span class="absolute -top-1 -left-1 text-[9px] bg-red-600 text-white px-1 rounded font-bold shadow-sm z-10">🔥</span>' : ''}
                             ${imgHtml}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start text-left">
                                <div>
                                    <h3 class="font-bold text-sm leading-tight ${textClass} uppercase">${p.name}</h3>
                                    <p class="text-[10px] text-gray-500 mt-1 bg-white/50 inline-block px-1 rounded font-mono text-left">EAN: ${p.id}</p>
                                    <div class="flex items-center gap-2 mt-1">
                                         <p class="text-[12px] text-red-500 font-bold line-through">Base: R$ ${p.base.toFixed(2).replace('.',',')}</p>
                                         <button onclick="openCalc('${p.id}')" class="text-blue-500 hover:text-blue-700 bg-white/50 p-1 rounded-full text-[10px]" title="Calculadora de Margem">
                                            <i class="fas fa-calculator"></i>
                                         </button>
                                    </div>
                                    <p class="text-xl font-black mt-0 ${isPromo ? 'text-green-600' : textClass} text-left">R$ ${currentPrice.toFixed(2).replace('.',',')}</p>
                                    ${nextTierHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mt-3 overflow-x-auto scrollbar-hide pb-1 pr-4">
                        ${p.tiers.map(t => {
                            const isReached = qty >= t.q;
                            const isCurrent = isReached && (p.tiers[p.tiers.indexOf(t)+1] ? qty < p.tiers[p.tiers.indexOf(t)+1].q : true);
                            
                            // Lógica de destaque para descontos altos (>= 19%)
                            const isHighDiscount = t.d >= 19;
                            const tierClass = isHighDiscount ? 'tier-active-campaign' : 'tier-active';
                            // Se não for o atual, mas for alcançado e high discount -> laranja claro. Se normal -> verde claro.
                            const reachedBg = isHighDiscount ? 'bg-orange-50 border-orange-200' : 'bg-green-50 border-green-200';
                            
                            return `
                            <div onclick="toggleQty('${p.id}', ${t.q})" class="tier-box ${isCurrent ? tierClass : (isReached ? reachedBg : 'bg-white')} rounded-lg px-2 py-1 text-[10px] min-w-[75px] flex flex-col items-center shadow-sm transition-all relative">
                                <span class="font-bold uppercase">${t.q} un</span>
                                <span class="text-xs">R$ ${t.p.toFixed(2).replace('.',',')}</span>
                                <span class="text-[9px] ${isHighDiscount ? 'text-orange-600 font-black' : (t.d > 0 ? 'text-green-600 font-bold' : 'text-gray-400')}">
                                    ${t.d > 0 ? `(-${t.d}% OFF)` : ''} ${isHighDiscount ? '🔥' : ''}
                                </span>
                            </div>`;
                        }).join('')}
                    </div>

                    <div class="flex items-center justify-between mt-2 bg-white/60 p-1.5 rounded-xl border border-white/60 backdrop-blur-sm">
                        <button onclick="changeQty('${p.id}', -1)" class="w-10 h-10 bg-white rounded-lg shadow-sm text-gray-600 font-bold active:bg-gray-100 transition-colors">-</button>
                        <input type="number" value="${qty > 0 ? qty : ''}" placeholder="0" onchange="manualInput('${p.id}', this.value)" class="w-full text-center bg-transparent font-bold text-gray-800 text-lg focus:outline-none">
                        <button onclick="changeQty('${p.id}', 1)" class="w-10 h-10 ${badgeClass} rounded-lg shadow-md font-bold active:scale-95 transition-colors">+</button>
                    </div>`;
                container.appendChild(card);
                
                // Ativar lazy loading para esta imagem
                if (window.imgObserver) {
                    const lazyImg = card.querySelector('.lazy-img');
                    if (lazyImg) window.imgObserver.observe(lazyImg);
                }
            });
            updateCartBar();
        }

        // Funções de Carrinho e Persistência
        function toggleQty(id, t) { 
            cart[id] = (cart[id] === t) ? 0 : t; 
            saveCart();
            render(); 
        }
        function changeQty(id, delta) { 
            if (!cart[id]) cart[id] = 0; 
            cart[id] += delta; 
            if (cart[id] < 0) cart[id] = 0; 
            saveCart();
            render(); 
        }
        function manualInput(id, value) { 
            let val = parseInt(value); 
            if(isNaN(val) || val < 0) val = 0; 
            cart[id] = val; 
            saveCart();
            render(); 
        }
        
        function saveCart() {
            localStorage.setItem('opella_cart', JSON.stringify(cart));
        }

        // --- CLEAR CART SYSTEM ---
        function toggleScrollLock(lock) {
            if (lock) {
                document.documentElement.classList.add('no-scroll');
                document.body.classList.add('no-scroll');
            } else {
                document.documentElement.classList.remove('no-scroll');
                document.body.classList.remove('no-scroll');
            }
        }

        function askClearCart() {
            toggleScrollLock(true);
            document.getElementById('clear-modal').classList.remove('hidden');
        }

        function closeClearModal() {
            toggleScrollLock(false);
            document.getElementById('clear-modal').classList.add('hidden');
        }

        function performClearCart() {
            cart = {};
            saveCart();
            render();
            closeClearModal();
            closeModal(); // fecha o modal de checkout se estiver aberto
        }

        function clearCart() {
             askClearCart(); // Redireciona para o novo sistema
        }

        function updateCartBar() {
            let total = 0; let totalBase = 0; let count = 0;
            Object.keys(cart).forEach(id => { 
                const qty = cart[id]; 
                if(qty > 0) { 
                    const p = products.find(x => x.id == id); 
                    if(p) {
                        total += getPrice(p, qty) * qty; 
                        totalBase += p.base * qty;
                        count += qty; 
                    }
                } 
            });
            
            const savings = Math.max(0, totalBase - total);
            const savingsModal = document.getElementById('total-savings-modal');
            if(savingsModal) savingsModal.innerText = 'R$ ' + savings.toFixed(2).replace('.',',');

            const label = document.getElementById('installment-label');
            const installment = document.getElementById('cart-installment');
            const totalSmall = document.getElementById('cart-total-small');
            const progressFill = document.getElementById('progress-fill');
            const bar = document.getElementById('cart-bar');
            const btnReview = document.getElementById('btn-review');

            const progressPercent = Math.min((total / 500) * 100, 100);
            if(progressFill) progressFill.style.width = progressPercent + '%';

            if(total < MIN_ORDER) {
                if(progressFill) progressFill.className = "h-full bg-red-500 transition-all duration-500";
                const missing = (MIN_ORDER - total).toFixed(2).replace('.',',');
                if(label) label.innerHTML = `<span class="text-red-500 font-bold text-[12px] uppercase tracking-tighter text-left">Faltam R$ ${missing} para pedido mínimo</span>`;
                if(installment) {
                    installment.innerText = "R$ " + total.toFixed(2).replace('.',',');
                    installment.className = "text-2xl font-black text-gray-900 leading-none text-left text-left";
                }
                if(btnReview) btnReview.disabled = true;
            } else if (total >= 500) {
                if(progressFill) progressFill.className = "h-full bg-green-500 transition-all duration-500";
                if(label) label.innerHTML = `<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-[12px] font-black uppercase tracking-tight text-left">Prazo disponível: 40/60 dias</span>`;
                if(installment) {
                    installment.innerText = "2x de R$ " + (total/2).toFixed(2).replace('.',',');
                    installment.className = "text-2xl font-black text-green-600 leading-none text-left text-left";
                }
                if(btnReview) btnReview.disabled = false;
            } else {
                if(progressFill) progressFill.className = "h-full bg-blue-500 transition-all duration-500";
                const missing = (500 - total).toFixed(2).replace('.',',');
                if(label) label.innerHTML = `<span class="text-blue-600 font-bold text-[12px] uppercase tracking-tighter text-left">Faltam R$ ${missing} para parcelar</span>`;
                if(installment) {
                    installment.innerText = "R$ " + total.toFixed(2).replace('.',',');
                    installment.className = "text-2xl font-black text-gray-900 leading-none text-left text-left";
                }
                if(btnReview) btnReview.disabled = false;
            }
            
            if(totalSmall) totalSmall.innerText = `Total: R$ ${total.toFixed(2).replace('.',',')} (Econ: R$ ${savings.toFixed(2).replace('.',',')})`;
            if (count > 0 && bar) bar.classList.remove('hidden'); else if(bar) bar.classList.add('hidden');
        }

        // --- DASHBOARD SYSTEM ---
        function openDashboard() {
            toggleScrollLock(true);
            let total = 0; let totalBase = 0; let count = 0;
            let brandTotals = {};

            Object.keys(cart).forEach(id => { 
                const qty = cart[id]; 
                if(qty > 0) { 
                    const p = products.find(x => x.id == id); 
                    if(p) { // Check p
                        const price = getPrice(p, qty);
                        const val = price * qty;
                        total += val; 
                        totalBase += p.base * qty;
                        count += qty;
                        
                        brandTotals[p.cat] = (brandTotals[p.cat] || 0) + val;
                    }
                } 
            });

            document.getElementById('dash-total-items').innerText = count;
            document.getElementById('dash-total-savings').innerText = 'R$ ' + Math.max(0, totalBase - total).toFixed(2).replace('.',',');
            
            const listEl = document.getElementById('brand-summary-list');
            listEl.innerHTML = '';
            const sortedBrands = Object.entries(brandTotals).sort((a,b) => b[1] - a[1]);
            
            sortedBrands.forEach(([brand, val]) => {
                const perc = total > 0 ? (val/total)*100 : 0;
                listEl.innerHTML += `
                <div class="flex justify-between items-center text-xs border-b border-gray-100 last:border-0 py-2">
                    <span class="font-bold text-gray-700">${brand}</span>
                    <div class="text-right">
                        <span class="font-bold block">R$ ${val.toFixed(2).replace('.',',')}</span>
                        <span class="text-[9px] text-gray-400">${perc.toFixed(1)}%</span>
                    </div>
                </div>`;
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedBrands.map(x => x[0]),
                    datasets: [{
                        data: sortedBrands.map(x => x[1]),
                        backgroundColor: [
                            '#E20613', '#009EE2', '#C5007F', '#009640', '#FFBD59', 
                            '#F57F20', '#0055b8', '#003366', '#00aed9', '#FFD700', '#32CD32'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });

            document.getElementById('dashboard-modal').classList.remove('hidden');
        }

        function closeDashboard() {
            toggleScrollLock(false);
            document.getElementById('dashboard-modal').classList.add('hidden');
        }

        // --- CALCULATOR SYSTEM ---
        function openCalc(id) {
            try {
                // Safety first: Open modal before logic to avoid freeze
                document.getElementById('calc-modal').classList.remove('hidden');
                toggleScrollLock(true);

                currentCalcProduct = products.find(p => p.id === id);
                
                if (!currentCalcProduct) {
                    throw new Error("Produto não encontrado");
                }

                const toggle = document.getElementById('calc-fraction-toggle');
                toggle.classList.add('hidden'); // Always hide the toggle (choice is automatic)

                if(currentCalcProduct.fraction) {
                    // Hospital/Fractional items: force unit mode
                    setCalcMode('unit');
                } else {
                    // Standard items: force box mode
                    setCalcMode('box');
                }

                document.getElementById('calc-sell').value = ''; 
                // Removed auto-focus to prevent keyboard popup
                // document.getElementById('calc-sell').focus(); 
            } catch (e) {
                console.error("Erro na calculadora:", e);
                closeCalc(); // Auto-close on error to prevent lock
                alert("Erro ao abrir calculadora para este item.");
            }
        }

        function setCalcMode(mode) {
            calcMode = mode;
            // Button references kept for code compatibility, though hidden
            const btnBox = document.getElementById('btn-calc-box');
            const btnUnit = document.getElementById('btn-calc-unit');
            
            if(mode === 'box') {
                btnBox.className = "flex-1 py-1.5 text-[10px] font-bold rounded bg-yellow-400 text-white shadow-sm transition-all";
                btnUnit.className = "flex-1 py-1.5 text-[10px] font-bold rounded text-gray-500 hover:bg-gray-50 transition-all";
                document.getElementById('label-calc-cost').innerText = "Custo da Caixa (R$)";
                document.getElementById('label-calc-sell').innerText = "Venda da Caixa (R$)";
            } else {
                btnBox.className = "flex-1 py-1.5 text-[10px] font-bold rounded text-gray-500 hover:bg-gray-50 transition-all";
                btnUnit.className = "flex-1 py-1.5 text-[10px] font-bold rounded bg-yellow-400 text-white shadow-sm transition-all";
                const unitName = currentCalcProduct.fraction ? currentCalcProduct.fraction.unit : 'Unidade';
                document.getElementById('label-calc-cost').innerText = `Custo por ${unitName} (R$)`;
                document.getElementById('label-calc-sell').innerText = `Venda por ${unitName} (R$)`;
            }
            
            updateCalcValues();
            calculateMargin(); 
        }

        function updateCalcValues() {
            const qty = cart[currentCalcProduct.id] || 0;
            let cost = getPrice(currentCalcProduct, Math.max(1, qty));
            
            if(calcMode === 'unit' && currentCalcProduct.fraction) {
                cost = cost / currentCalcProduct.fraction.divisor;
            }
            
            document.getElementById('calc-cost').value = cost.toFixed(2);
        }

        function calculateMargin() {
            const cost = parseFloat(document.getElementById('calc-cost').value);
            const sell = parseFloat(document.getElementById('calc-sell').value);
            
            if(sell > 0) {
                const profit = sell - cost;
                const margin = (profit / sell) * 100;
                
                const resultEl = document.getElementById('calc-result');
                const valEl = document.getElementById('calc-profit-val');
                
                resultEl.innerText = margin.toFixed(1) + '%';
                valEl.innerText = 'Lucro: R$ ' + profit.toFixed(2).replace('.',',');
                
                if(margin < 0) {
                    resultEl.className = "text-3xl font-black text-red-400";
                } else if (margin < 20) {
                    resultEl.className = "text-3xl font-black text-yellow-400";
                } else {
                    resultEl.className = "text-3xl font-black text-green-400";
                }
            } else {
                 document.getElementById('calc-result').innerText = '0.0%';
                 document.getElementById('calc-profit-val').innerText = 'Lucro: R$ 0,00';
                 document.getElementById('calc-result').className = "text-3xl font-black";
            }
        }

        function closeCalc() {
            toggleScrollLock(false);
            document.getElementById('calc-modal').classList.add('hidden');
        }

        // --- HISTORY SYSTEM ---
        function saveToHistory(total) {
            const now = new Date();
            const record = {
                date: now.toLocaleString('pt-BR'),
                total: total,
                itemsCount: Object.values(cart).reduce((a,b)=>a+b,0),
                cartSnapshot: JSON.parse(JSON.stringify(cart))
            };
            orderHistory.unshift(record);
            if(orderHistory.length > 5) orderHistory.pop(); 
            localStorage.setItem('opella_history', JSON.stringify(orderHistory));
            updateHistoryList();
        }

        function updateHistoryList() {
            const container = document.getElementById('history-list');
            if(!container) return;
            container.innerHTML = '';
            
            if(orderHistory.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Nenhum pedido anterior.</p>';
                return;
            }

            orderHistory.forEach((rec, idx) => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 rounded-xl border border-gray-200 flex justify-between items-center";
                div.innerHTML = `
                    <div>
                        <p class="text-xs font-bold text-gray-700">${rec.date}</p>
                        <p class="text-[10px] text-gray-500">${rec.itemsCount} itens</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-green-700">R$ ${rec.total.toFixed(2).replace('.',',')}</p>
                        <button onclick="restoreCart(${idx})" class="text-[9px] text-blue-600 underline font-bold">Carregar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function restoreCart(idx) {
            // Pequeno modal ou confirm customizado seria ideal, mas aqui um alert simples ajuda no debug rápido, 
            // porém, seguindo a regra de não usar confirm/alert, vamos apenas carregar direto.
            cart = orderHistory[idx].cartSnapshot;
            saveCart();
            render();
            closeHistoryModal();
        }
        
        function clearHistory() {
            orderHistory = [];
            localStorage.removeItem('opella_history');
            updateHistoryList();
        }

        function openHistoryModal() {
            toggleScrollLock(true);
            document.getElementById('history-modal').classList.remove('hidden');
        }
        function closeHistoryModal() {
            toggleScrollLock(false);
            document.getElementById('history-modal').classList.add('hidden');
        }

        // --- PDF EXPORT ---
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("Pedido Opella - Fev 2026", 14, 20);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const date = new Date().toLocaleString('pt-BR');
            doc.text(`Data: ${date}`, 14, 26);
            
            const cnpj = document.getElementById('cnpj-input').value || "Não informado";
            doc.text(`CNPJ Cliente: ${cnpj}`, 14, 32);

            let tableRows = [];
            let total = 0;
            
            const sortedCartIds = Object.keys(cart).sort((a,b) => {
                const pA = products.find(x => x.id == a);
                const pB = products.find(x => x.id == b);
                return (pA?.cat || '').localeCompare(pB?.cat || '');
            });

            sortedCartIds.forEach(id => {
                const qty = cart[id];
                if(qty > 0) {
                    const p = products.find(x => x.id == id);
                    const price = getPrice(p, qty);
                    const subtotal = price * qty;
                    total += subtotal;
                    tableRows.push([p.cat, p.name, qty, `R$ ${price.toFixed(2)}`, `R$ ${subtotal.toFixed(2)}`]);
                }
            });

            doc.autoTable({
                startY: 40,
                head: [['Marca', 'Produto', 'Qtd', 'Unit.', 'Total']],
                body: tableRows,
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74] } // Green-600
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL GERAL: R$ ${total.toFixed(2).replace('.',',')}`, 14, finalY);
            
            // Lógica de prazo no PDF (Removida a opção especial de 3k)
            let prazoTexto = "50 dias direto";
            if(total >= 500) {
                 const elem = document.querySelector('input[name="prazo"]:checked');
                 prazoTexto = elem ? elem.value : "2x (40/60 dias)";
            }

            doc.setFont("helvetica", "normal");
            doc.text(`Condição de Pagamento: ${prazoTexto}`, 14, finalY + 6);

            doc.save('pedido_opella.pdf');
        }

        // --- CORE FUNCTIONS ---
        function openModal() { 
            toggleScrollLock(true);

            const container = document.getElementById('cart-items-preview');
            const savingsModal = document.getElementById('total-savings-modal');
            container.innerHTML = '';
            
            let total = 0;
            let totalBase = 0;
            
            // Agrupar por marca
            const brandGroups = {};

            const sortedCartIds = Object.keys(cart).sort((a,b) => {
                const pA = products.find(x => x.id == a);
                const pB = products.find(x => x.id == b);
                return (pA?.cat || '').localeCompare(pB?.cat || '');
            });

            sortedCartIds.forEach(id => {
                const qty = cart[id];
                if(qty > 0) {
                    const p = products.find(x => x.id == id);
                    if (p) {
                        const price = getPrice(p, qty);
                        total += price * qty;
                        totalBase += p.base * qty;
                        
                        if (!brandGroups[p.cat]) {
                            brandGroups[p.cat] = { items: [], subtotal: 0 };
                        }
                        brandGroups[p.cat].items.push({ product: p, qty, price });
                        brandGroups[p.cat].subtotal += price * qty;
                    }
                }
            });

            // Renderizar agrupado por marca
            const brandColors = {
                'Dorflex': '#E20613', 'Enterogermina': '#009EE2', 'Allegra': '#C5007F',
                'Novalgina': '#009640', 'Anador': '#FFBD59', 'Targifor': '#F57F20',
                'Moura': '#0055b8', 'Oscal': '#003366', 'Dulco': '#00aed9',
                'Bisolvon': '#FFD700', 'Fenergan': '#32CD32'
            };

            Object.keys(brandGroups).forEach(cat => {
                const group = brandGroups[cat];
                const color = brandColors[cat] || '#6b7280';
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'brand-summary-checkout';
                
                let itemsHtml = group.items.map(item => `
                    <div class="flex gap-2 items-center py-1 text-left">
                        <img src="${item.product.image}" class="w-8 h-8 object-contain mix-blend-multiply bg-white rounded p-0.5 border">
                        <div class="flex-1 min-w-0">
                            <p class="text-[9px] font-bold text-gray-700 truncate">${item.product.name}</p>
                            <p class="text-[8px] text-gray-500">${item.qty} un × R$ ${item.price.toFixed(2).replace('.',',')}</p>
                        </div>
                        <p class="text-[10px] font-bold text-gray-800">R$ ${(item.price * item.qty).toFixed(2).replace('.',',')}</p>
                    </div>
                `).join('');
                
                groupDiv.innerHTML = `
                    <div class="brand-header">
                        <span class="brand-dot" style="background-color: ${color}"></span>
                        <span class="text-[10px] font-bold text-gray-700 flex-1">${cat}</span>
                        <span class="text-[10px] font-bold text-gray-900">R$ ${group.subtotal.toFixed(2).replace('.',',')}</span>
                    </div>
                    ${itemsHtml}
                `;
                
                container.appendChild(groupDiv);
            });

            const savings = Math.max(0, totalBase - total);
            if(savingsModal) savingsModal.innerText = 'R$ ' + savings.toFixed(2).replace('.',',');

            // --- Lógica de Pagamento Simplificada ---
            // Removemos a opção de prazo especial para > 3k.
            if (total >= 500) {
                document.getElementById('payment-options').classList.remove('hidden');
                document.getElementById('payment-single').classList.add('hidden');

                const grid = document.getElementById('payment-options-grid');
                grid.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded-lg border border-blue-200 hover:border-blue-400 transition-all text-left">
                        <input type="radio" name="prazo" value="2x (40/60 dias)" class="w-4 h-4 text-blue-600" checked>
                        <span class="text-[10px] font-bold text-gray-800">2x (40/60 dias)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded-lg border border-blue-200 hover:border-blue-400 transition-all text-left">
                        <input type="radio" name="prazo" value="50 dias direto" class="w-4 h-4 text-blue-600">
                        <span class="text-[10px] font-bold text-gray-800 text-left">50 dias direto</span>
                    </label>
                `;
            } else {
                document.getElementById('payment-options').classList.add('hidden');
                document.getElementById('payment-single').classList.remove('hidden');
            }

            document.getElementById('checkout-modal').classList.remove('hidden'); 
        }

        function closeModal() { 
            toggleScrollLock(false);
            document.getElementById('checkout-modal').classList.add('hidden'); 
        }
        
        function saveAndSendWhatsapp() {
            const cnpj = document.getElementById('cnpj-input').value; 
            if(!cnpj) { alert("Por favor, digite o CNPJ."); return; }
            
            // --- HEADER OTIMIZADO PARA PC/MOBILE ---
            let text = `*PEDIDO OPELLA | FEV 2026*\n`;
            text += `--------------------------------\n`;
            text += `CNPJ: ${cnpj}\n`;
            text += `DATA: ${new Date().toLocaleDateString('pt-BR')}\n`;
            
            let total = 0; let totalBase = 0; let itemCount = 0;
            const sortedCartIds = Object.keys(cart).sort((a,b) => {
                const pA = products.find(x => x.id == a);
                const pB = products.find(x => x.id == b);
                return (pA?.cat || '').localeCompare(pB?.cat || '');
            });

            let currentCat = '';

            sortedCartIds.forEach(id => {
                const qty = cart[id];
                if(qty > 0) {
                    const p = products.find(x => x.id == id);
                    if (p) {
                        const price = getPrice(p, qty);
                        
                        // Separador de Categoria Limpo
                        if(p.cat !== currentCat) {
                            text += `\n*--- ${p.cat.toUpperCase()} ---*\n`;
                            currentCat = p.cat;
                        }
                        
                        total += price * qty;
                        totalBase += p.base * qty;
                        itemCount += qty;
                        
                        // Item formatado: Qtd, Nome, Preço com '└', EAN com '>' (Citação)
                        text += `  *${qty}x* ${p.name}\n`;
                        text += `   └ R$ ${price.toFixed(2).replace('.',',')} un\n`;
                        text += `> EAN: ${p.id}\n`;
                    }
                }
            });

            const savings = totalBase - total;
            
            // Rodapé Financeiro Limpo
            text += `\n══════════════`;
            text += `\n*TOTAL:* R$ ${total.toFixed(2).replace('.',',')}`;
            text += `\n*ECONOMIA:* R$ ${savings.toFixed(2).replace('.',',')}`;

            // Lógica de prazo no WhatsApp
            if (total >= 500) {
                const prazoElem = document.querySelector('input[name="prazo"]:checked');
                const prazo = prazoElem ? prazoElem.value : "50 dias direto";
                text += `\n*PRAZO:* ${prazo}`;
            } else {
                text += `\n*PRAZO:* 50 dias direto`;
            }
            text += `\n══════════════`;

            text += `\n\n> Aguardo faturamento.`;
            
            // === SALVAR NO HISTÓRICO PARA QUICK REORDER ===
            const newOrder = {
                id: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                cnpj: cnpj,
                total: total,
                itemsCount: itemCount,
                cartSnapshot: JSON.parse(JSON.stringify(cart))
            };
            orderHistory.unshift(newOrder);
            if (orderHistory.length > 10) orderHistory = orderHistory.slice(0, 10);
            localStorage.setItem('opella_history', JSON.stringify(orderHistory));
            updateQuickReorderBar();
            // ================================================
            
            // Salvar no Histórico (função original)
            saveToHistory(total);
            
            const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
            window.location.href = url;
        }
    </script>
</body>
</html>